<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no">
    <meta name=format-detection content="telephone=no">
    <title>飞机</title>
    <script src="./js/config.js"></script>
    <script src="js/jquery-2.1.4.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <link rel="stylesheet" href="./css/pace-theme-big-counter.css">
    <link rel="stylesheet" href="./css/main.css">

    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script> 
    <script src="js/pace.min.js"></script>

    <script type="text" id="myId">
        <br>
        <div class="splash card"><br>
            <p class="lead" style="text-align:center"></p>

            <div class="progress">
                <div class="barcontainer">
                    <div class="mybar" role="bar">
                        <img src="./img/jindutiao_3.png" >
                    </div>
                </div>
            </div>
        </div><br>
    </script>
    <!-- 分享 -->
    <script src=http://res.wx.qq.com/open/js/jweixin-1.2.0.js></script>
    <script type=text/javascript src=http://www.bjweifeng.cn/zimuWx/js/yundaoWxV2.0.js></script>
    <script>
        yundaoWx.share_title = "标题";
        yundaoWx.share_desc = "描述";
        yundaoWx.share_link = "http://h5.sjzzimu.com/baidufeiji/index.html";
        yundaoWx.share_imgUrl = "http://h5.sjzzimu.com/holiday/static/min.png";
        yundaoWx.share();
    </script>
    <!-- 统计 -->
    
    <script>
        var _mtac = {};
        (function () {
            var mta = document.createElement("script");
            mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.2";
            mta.setAttribute("name", "MTAH5");
            mta.setAttribute("sid", "500530692");
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(mta, s);
        })();

    </script>

</head>
<style>
    .select {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: #f7f7f7;
        z-index: 100;
        background: url("./img/mcbj.png") 0 0;
        background-size: 100% 100%;
        padding-top: 15%;
    }
    .item {
        width: 27%;
        float: left;
        margin-left: 5%;
        margin-top: 1.2rem;
    }
    .item img {
        width: 100%;
    }
    .change_addr {
        bottom: 7rem;
        background: url("./img/xzjc.png") 0 0;
        background-size: 100% 100%;
    }
    .button_clear {
        position: absolute;
        background: url(../img/qianming_2.png) 0 0;
        background-size: 100% 100%;
        bottom: 9rem;
        left: 40%;
        width: 20%;
        height: 0.9rem;
    }
</style>
<body>
    <div class="main" style="visibility: hidden;">
        <div class="select">
            <div class="selectaddr"></div>
        </div>
        <div class="page-1">
            <div class="template">
                <img src="" alt="">
            </div>
            <div class="autograph_container" style="background: #fff">
                <canvas id="c4"></canvas>
            </div>
            <div class="input_container">
                <input type="text" value="" name="input" placeholder="请在这里输入姓名">
            </div>
            <div class="button_clear">
            </div>
            <div class="change_addr btn"></div>
            <div class="change_templage btn"></div>
            <div class="ok btn"></div>
        </div>

        <div class="page-2">
            <div class="photo" style=" border: 1px #eee solid;">
                <img src="" alt="" class="path" style="top:-3rem;">
            </div>
            <div class="save">
            </div>
            <div class="baidu">
            </div>
            <div class="search">
            </div>
            <div class="share_btn">
            </div>
            <div style="display: none">
                <!-- <canvas id="textrue" width="108" height="192" style="border:1px solid"></canvas> -->
                <canvas id="textrue" width="556" height="700" style="border:1px solid"></canvas>
            </div>
        </div>
        <div class="share">
        </div>
    </div>

</body>

<script src="js/canvasSign.jquery.js"></script>
<script>
    $(function () {
         NProgress.configure({
            template: $('#myId').html(), // template是用来设置动画样式的属性
            trickleRate: 0.1, trickleSpeed: 100
        });

        NProgress.start()
        // 加载完
        Pace.on('done', function () {
            Pace.stop()
            NProgress.done()
            $('.main').css('visibility', 'visible')

        })
        // 不同系统模板图片不同
        var u = navigator.userAgent, app = navigator.appVersion;
        var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; //android终端或者uc浏览器
        var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
        console.log('是否是Android：' + isAndroid);
        console.log('是否是iOS：' + isiOS);

        if (isiOS) {
            var template = [
                'img/1ios.png',
                'img/2ios.png',
                'img/4ios.png',
                'img/5ios.png',
            ]
            console.log('ios')
        } else if (isAndroid) {
            var template = [
                'img/1android.png',
                'img/2android.png',
                'img/4android.png',
                'img/5android.png',
            ]
            console.log('android')
        }
        const addr = [
            "巴黎戴高乐机场",
            "北京首都国际机场",
            "成都双流国际机场",
            "广州白云国际机场",
            "贵阳龙洞堡机场",
            "哈尔滨太平国际机场",
            "海口美兰国际机场",
            "杭州萧山国际机场",
            "里约热内卢机场",
            "洛杉矶国际机场",
            "南京禄口国际机场",
            "青岛流亭机场",
            "厦门高崎国际机场",
            "上海虹桥国际机场",
            "深圳宝安国际机场",
            "沈阳桃仙国际机场",
            "石家庄正定国际机场",
            "悉尼·京斯福特·史密斯机场",
            "西安咸阳国际机场",
            "重庆江北国际机场",
        ]
        // 添加飞机场地址
        let selectAddr = ''

        for (let i = 0; i < 20; i++) {
            let classIndex = parseInt(`${i}-item`)
            let className = `.${i}-item`
            $('.selectaddr').before("<div  class=" + `${i}-item` +"><img src='./img/" + `${i+1}` +".png'></div>")
            $(className).on('touchstart', function () {
                console.log(className, classIndex)
                selectAddr = addr[classIndex]
                console.log(selectAddr)
                $('.select').fadeOut()
            })
        }    
        $('.select > div').addClass('item')
        $('.change_addr').on('touchstart', function () {
            $('.select').fadeIn()
        })
        

        let canvasWidth = parseInt($('.autograph_container').css('width'))
        let canvasHeight = parseInt($('.autograph_container').css('height'))
        config = {
            width: canvasWidth,	//canvas宽度
            height: canvasHeight,	//canvas高度
            lineWidth: 8,	//笔画最大线条宽度
            minLineWidth: 1,//最小线条宽度
            maskIng: {		//遮罩 只能规定字体，并且只能垂直居中显示
                isMask: true, //默认没有
                maskText: '请在这里手写签名',  //遮罩text
                maskLineHeight: 40,	//遮罩text行高，默认40
                maskFont: 'bold 26px 楷体', //遮罩字体
                maskColor: '#7D7D7D'	//文本颜色
            },
            lineColor: 'block',	//线条颜色 默认黑色
            bgColor: 'rgba(255,255,255,0)', //背景颜色
            bgImgSrc: null,	//背景图片 默认为空
            bgRetain: true	//false ：在写的过程中会清空背景图片及背景颜色 true ：会保留背景图片及背景颜色
        }
        

        $('#c4').canvasSign(config);
        $('.button_clear').click(function () {
            $('#c4').clear()
        });

        // 设置图片模板
        let index = 0
        $('.input_container ').css('display', 'display')
        $('.button_clear').css('display', 'none')

        $('.template > img').attr('src', template[0])

        $('.change_templage').click(function () {
            index++
            // console.log(index)
            if (index == template.length) {
                index = 0
            }
            $('.template > img').attr('src', template[index])
            // index 为1的时候，变为输入框
            if (index == 3) {
                $('.input_container ').css('display', 'none')
                $('.autograph_container').css('display', 'block')
                $('.button_clear').css('display', 'block')
                
            } else {
                $('.autograph_container ').css('display', 'none')
                $('.input_container').css('display', 'block')
                $('.button_clear').css('display', 'none')
            }
        })
        let dataURL = ''
        var ctx = document.getElementById('textrue').getContext('2d');
        // 点击生成签名
        $('.ok').on('touchstart', function () {
            dataURL = $('#c4').getDataURL();


            $('.page-1 ').css('display', 'none')
            $('.page-2 ').css('display', 'block')

            // 合成背景图
            var imgbg = new Image()
            imgbg.src = template[index]
            imgbg.onload = function () {
            ctx.drawImage(imgbg, 0, 0, 556, 700)
            // 机场地址
            ctx.font = '40px 黑体';
            ctx.fillStyle = '#67789d';
            ctx.fillText(selectAddr, 30, 670);
                //判断模板合成
                if (index == 3) {
                    console.log(index)
                    draw()
                } else {
                    input()
                }
            }
        })

        // 合成图片
        function draw() {
            // 签名
            var imgtextrue = new Image()
            imgtextrue.src = dataURL
            imgtextrue.onload = function () {
                ctx.setTransform(1, 0, 0, 1, 253, 310);
                ctx.rotate(-10 * Math.PI / 180);
                ctx.drawImage(imgtextrue, 0, 0, 80, 40) //生成签名尺寸
                // todataurl 跨域，应该使用本域下的图片
                var path = document.getElementById('textrue').toDataURL("image/jpeg", 1.0)
                $('.path').attr('src', path)
            }
        }
        // 输入名字
        function input() {
            var inputName = $(" input[ name='input' ] ").val()
            if(index == 0 ) {
                ctx.font = '13px 黑体';
                ctx.fillStyle = '#415a69';
                ctx.fillText(inputName, 380, 135);
            }else if(index == 1) {
                ctx.font = '10px 黑体';
                ctx.fillStyle = '#000';
                ctx.fillText(inputName, 366, 433);
            }else {
                ctx.font = '13px 黑体';
                ctx.fillStyle = '#6d7990';
                ctx.fillText(inputName, 168, 200);
            }
            var path = document.getElementById('textrue').toDataURL("image/jpeg", 1.0)
            $('.path').attr('src', path)

        }

        //分享
        $('.share_btn').on('touchstart', function () {
            $('.share').css('display', 'block')
        })
        $('.share').on('touchstart', function () {
            $('.share').css('display', 'none')
        })
        $('.baidu').on('touchstart', function () {
            $(window).attr('location', 'https://www.baidu.com/');
        })
        /*微信白条*/
        $('body').on('touchmove', function (event) {
            event.preventDefault();
        })
        console.log(template)
    })

</script>

</html>